<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gemini 3 Pro Image Preview API 调用器</title>
  <meta name="description" content="基于 GitHub Pages 的 Gemini 3 调用器：图像生成/编辑 + 图片反推提示词" />
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <header class="header">
    <div class="container">
      <div class="title-row">
        <div class="title-left">
          <h1 class="title">Gemini 3 调用器（图像生成 + 反推提示词）</h1>
          <p class="subtitle">
            支持：Host / API Key / 系统提示词 / 提示词（可空）/ 多图输入 / 生成参数（仅图像模式）/ 预设 / JSON 请求体 / 特殊模式：反推提示词（gemini-3-pro-preview）
          </p>
        </div>

        <div class="presetbar" aria-label="预设工具栏">
          <select id="presetSelect" class="presetSelect" title="选择预设/模式">
            <option value="">（无预设）</option>
          </select>
          <button id="presetSave" type="button" class="btn secondary">保存为预设</button>
          <button id="presetUpdate" type="button" class="btn secondary" disabled>更新预设</button>
          <button id="presetDelete" type="button" class="btn secondary" disabled>删除预设</button>
          <button id="presetExport" type="button" class="btn secondary">导出</button>

          <label class="btn secondary filebtn" title="导入预设（JSON）">
            导入
            <input id="presetImport" type="file" accept="application/json" />
          </label>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2 class="section-title">配置</h2>

      <form id="form" autocomplete="off">
        <div class="grid">
          <label class="field">
            <span class="label">API 主机地址（可选）</span>
            <input id="apiHost" type="text" inputmode="url" placeholder="留空则使用 Google 官方主机" />
            <span class="hint">可填你的反代/网关域名；留空默认官方。</span>
          </label>

          <label class="field">
            <span class="label">API Key</span>
            <input id="apiKey" type="password" placeholder="粘贴你的 Gemini API Key" />
            <div class="row">
              <label class="checkbox">
                <input id="rememberKey" type="checkbox" />
                <span>在本机保存 Key（localStorage）</span>
              </label>
              <label class="checkbox">
                <input id="useHeaderKey" type="checkbox" />
                <span>把 Key 放到 Header（x-goog-api-key）</span>
              </label>
            </div>
            <span class="hint">GitHub Pages 为纯前端，无法真正隐藏 Key；建议做来源域名限制或使用服务端中转。</span>
          </label>
        </div>

        <div class="modebar" role="tablist" aria-label="请求体编辑模式">
          <button id="modeForm" type="button" class="seg active" role="tab" aria-selected="true">表单模式</button>
          <button id="modeJson" type="button" class="seg" role="tab" aria-selected="false">JSON 模式</button>
        </div>

        <div id="formModeWrap">
          <div class="grid">
            <label class="field full">
              <span class="label">系统提示词（可选）</span>
              <textarea id="systemPrompt" rows="3" placeholder="例如：你是一个专业平面设计师…… / 或对反推输出的格式要求……"></textarea>
            </label>

            <label class="field full">
              <span class="label">提示词（可选）</span>
              <textarea id="prompt" rows="5" placeholder="可留空：将传入空文本。反推模式下可写补充要求，如“更偏电影感”“尽量保留logo”等。"></textarea>
              <span class="hint">若留空，将仍发送一个空文本 part（{ "text": "" }）。</span>
            </label>

            <!-- 反推模式专用 -->
            <label class="field full describeOnly hidden" id="describeTargetWrap">
              <span class="label">反推提示词选项（仅在“反推提示词模式”启用）</span>
              <select id="describeTarget">
                <option value="full">全图（主体 + 动作 + 背景 + 风格/画风）</option>
                <option value="background">仅背景（环境/场景/光照/材质/氛围）</option>
                <option value="person">仅人物（外观/服饰/姿态/表情/动作）</option>
                <option value="style">仅风格（风格体系 + 关键词簇 + 可迁移风格模板）</option>
                <option value="rendering">仅画风（渲染/笔触/线稿/材质/颗粒/镜头质感等极细节）</option>
              </select>
              <span class="hint">
                反推模式会调用 gemini-3-pro-preview，要求至少上传 1 张图片；输出会给出可直接用于 gemini-3-pro-image-preview 的超详细“格式化提示词”。
              </span>
            </label>

            <div class="field full">
              <span class="label">输入图片（可选；反推模式必选；支持多张）</span>
              <div id="dropZone" class="dropzone" role="button" tabindex="0">
                <div class="dz-main">
                  <strong>拖拽图片到这里</strong>
                  <span>或点击选择文件（可多选：PNG/JPEG/WebP/HEIC 等）</span>
                </div>
                <input id="imageFile" type="file" accept="image/*" multiple />
              </div>

              <div id="imagesPreview" class="previewlist hidden">
                <div class="previewlist-head">
                  <div id="imagesMeta"></div>
                  <div class="previewlist-actions">
                    <button id="clearImages" type="button" class="btn secondary">清空图片</button>
                  </div>
                </div>
                <div id="imagesPreviewGrid" class="previewgrid"></div>
              </div>

              <span class="hint">会按选择顺序将多张图片追加为多个 inline_data parts 发送。</span>
            </div>

            <!-- 图像生成专用参数（反推模式会隐藏） -->
            <label class="field genOnly">
              <span class="label">生成图片比例（可选，仅图像模式）</span>
              <select id="aspectRatio">
                <option value="">默认（模型自行选择）</option>
                <option value="1:1">1:1</option>
                <option value="2:3">2:3</option>
                <option value="3:2">3:2</option>
                <option value="3:4">3:4</option>
                <option value="4:3">4:3</option>
                <option value="4:5">4:5</option>
                <option value="5:4">5:4</option>
                <option value="9:16">9:16</option>
                <option value="16:9">16:9</option>
                <option value="21:9">21:9</option>
              </select>
            </label>

            <label class="field genOnly">
              <span class="label">分辨率（可选，仅图像模式）</span>
              <select id="imageSize">
                <option value="">默认（1K）</option>
                <option value="1K">1K</option>
                <option value="2K">2K</option>
                <option value="4K">4K</option>
              </select>
              <span class="hint">4K 成本更高、延迟更大。</span>
            </label>

            <label class="field genOnly">
              <span class="label">Temperature（可选，仅图像模式，0–2）</span>
              <input id="temperature" type="number" inputmode="decimal" min="0" max="2" step="0.1" placeholder="留空使用模型默认" />
            </label>

            <label class="field genOnly">
              <span class="label">TopP（可选，仅图像模式，0–1）</span>
              <input id="topP" type="number" inputmode="decimal" min="0" max="1" step="0.05" placeholder="留空使用模型默认" />
            </label>
          </div>
        </div>

        <div id="jsonModeWrap" class="hidden">
          <div class="jsonbar">
            <button id="jsonFormat" type="button" class="btn secondary">格式化 JSON</button>
            <button id="jsonFromForm" type="button" class="btn secondary">从表单同步</button>
            <button id="jsonToForm" type="button" class="btn secondary">回填到表单</button>
          </div>

          <label class="field full">
            <span class="label">请求体 JSON（将直接作为 POST body 发送）</span>
            <textarea id="requestBodyJson" rows="16" spellcheck="false"
              placeholder='例如：{"contents":[{"role":"user","parts":[{"text":""}]}]}'></textarea>
            <span class="hint">提示：Host / Key 不在此 JSON 中；仍由上方固定配置决定。</span>
          </label>
        </div>

        <div class="actions">
          <button id="runBtn" class="btn primary" type="submit">调用 API 生成</button>
          <button id="resetBtn" class="btn secondary" type="button">重置（不清 Host/Key）</button>
        </div>

        <div>
          <div id="status" class="status hidden"></div>
        </div>
      </form>
    </section>

    <section class="card">
      <h2 class="section-title">结果</h2>

      <div id="resultEmpty" class="empty">
        尚未生成。提交后会在这里显示图片与返回文本。
      </div>

      <div id="result" class="hidden">
        <div class="result-head">
          <div>
            <div class="kpi">
              <span class="kpi-label">模型</span>
              <span class="kpi-value" id="modelName"></span>
            </div>
            <div class="kpi">
              <span class="kpi-label">耗时</span>
              <span class="kpi-value" id="latency"></span>
            </div>
          </div>

          <div class="result-actions">
            <button id="copyCurl" type="button" class="btn secondary">复制 cURL</button>
            <button id="copyJson" type="button" class="btn secondary">复制请求 JSON</button>
          </div>
        </div>

        <div id="textOutWrap" class="block hidden">
          <h3 class="block-title">文本输出</h3>
          <pre id="textOut" class="pre"></pre>
        </div>

        <div id="imagesOutWrap" class="block hidden">
          <h3 class="block-title">图片输出</h3>
          <div id="imagesOut" class="gallery"></div>
          <p class="hint">
            iOS Safari 如遇“下载”不生效，请点击“打开原图”后长按图片保存到相册。
          </p>
        </div>

        <details class="details">
          <summary>查看原始响应 JSON</summary>
          <pre id="rawJson" class="pre"></pre>
        </details>
      </div>
    </section>

    <footer class="footer">
      <p class="footnote">
        说明：本页面仅做前端调用封装。建议对 API Key 做来源域名限制，或使用自建反代/Worker 将 Key 置于服务端。
      </p>
    </footer>
  </main>

  <script type="module" src="./app.js"></script>
</body>
</html>