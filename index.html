<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gemini 3 调用器（图像生成 + 提示词反推）</title>
  <meta name="description" content="GitHub Pages 上的 Gemini 3 调用器：图像生成/编辑 + 图片反推提示词" />
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <header class="header">
    <div class="container">
      <div class="title-row">
        <div class="title-left">
          <h1 class="title">Gemini 3 调用器（图像生成 + 提示词反推）</h1>
          <p class="subtitle">
            支持：Host / API Key / 多图输入 / 图像生成（gemini-3-pro-image-preview）/ 提示词反推（gemini-3-pro-preview）/ 预设 / JSON 请求体
          </p>
        </div>

      </div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2 class="section-title">配置</h2>

      <form id="form" autocomplete="off">
        <!-- 顶层功能选项卡（提前到预设栏上方） -->
        <div class="tabbar modebar" role="tablist" aria-label="功能选项卡">
          <button id="tabGen" type="button" class="seg active" role="tab" aria-selected="true">图像生成</button>
          <button id="tabDesc" type="button" class="seg" role="tab" aria-selected="false">提示词反推</button>
        </div>

        <!-- 全局预设工具栏：图像生成 / 提示词反推共用 -->
        <div id="presetbar" class="presetbar" aria-label="预设工具栏">
          <select id="presetSelect" class="presetSelect" title="选择当前模式预设">
            <option value="">（无预设）</option>
          </select>
          <button id="presetSave" type="button" class="btn secondary">添加预设</button>
          <button id="presetUpdate" type="button" class="btn secondary" disabled>更新预设</button>
          <button id="presetDelete" type="button" class="btn secondary" disabled>删除预设</button>
          <button id="presetExport" type="button" class="btn secondary">批量导出预设</button>

          <label class="btn secondary filebtn" title="导入预设（JSON）">
            批量导入预设
            <input id="presetImport" type="file" accept="application/json" />
          </label>
        </div>

        <div class="grid">
          <label class="field">
            <span class="label">API 主机地址（可选）</span>
            <input id="apiHost" type="text" inputmode="url" placeholder="留空则使用 Google 官方主机" />
            <span class="hint">可填入你的反代/网关域名；留空默认官方。</span>
          </label>

          <label class="field">
            <span class="label">API Key</span>
            <input id="apiKey" type="password" placeholder="粘贴你的 Gemini API Key" />
            <div class="row">
              <label class="checkbox">
                <input id="rememberKey" type="checkbox" />
                <span>在本机保存 Key（localStorage）</span>
              </label>
              <label class="checkbox">
                <input id="useHeaderKey" type="checkbox" />
                <span>把 Key 放到 Header（x-goog-api-key）</span>
              </label>
            </div>
            <span class="hint">GitHub Pages 为纯前端，无法真正隐藏 Key；建议做来源域名限制或使用服务端中转。</span>
          </label>
        </div>

        <!-- 共用：输入图片 -->
        <div class="grid">
          <div class="field full">
            <span class="label">输入图片（图像生成可选；提示词反推必选；支持多张）</span>
            <div id="dropZone" class="dropzone" role="button" tabindex="0">
              <div class="dz-main">
                <strong>拖拽图片到这里</strong>
                <span>或点击选择文件（可多选：PNG/JPEG/WebP/HEIC 等）</span>
              </div>
              <input id="imageFile" type="file" accept="image/*" multiple />
            </div>

            <div id="imagesPreview" class="previewlist hidden">
              <div class="previewlist-head">
                <div id="imagesMeta"></div>
                <div class="previewlist-actions">
                  <button id="clearImages" type="button" class="btn secondary">清空图片</button>
                </div>
              </div>
              <div id="imagesPreviewGrid" class="previewgrid"></div>
            </div>

            <span class="hint">会按选择顺序将多张图片追加为多个 inline_data parts 发送。</span>
          </div>
        </div>

        <!-- ============== 图像生成面板 ============== -->
        <div id="paneGen">
          <div class="modebar" role="tablist" aria-label="请求体编辑模式（仅图像生成）">
            <button id="modeForm" type="button" class="seg active" role="tab" aria-selected="true">表单模式</button>
            <button id="modeJson" type="button" class="seg" role="tab" aria-selected="false">JSON 模式</button>
          </div>

          <div id="formModeWrap">
            <div class="grid">
              <label class="field full">
                <span class="label">系统提示词（可选）</span>
                <textarea id="systemPrompt" rows="3" placeholder="例如：你是一个专业平面设计师，输出图片需要干净背景、柔光、高清。"></textarea>
              </label>

              <label class="field full">
                <span class="label">提示词（可选）</span>
                <textarea id="prompt" rows="5" placeholder="可留空：将传入空文本。若上传图片，可仅通过系统提示词/图片进行编辑。"></textarea>
                <span class="hint">若留空，将仍发送一个空文本 part（{ "text": "" }）。</span>
              </label>

              <label class="field">
                <span class="label">生成图片比例（可选）</span>
                <select id="aspectRatio">
                  <option value="">默认（模型自行选择）</option>
                  <option value="1:1">1:1</option>
                  <option value="2:3">2:3</option>
                  <option value="3:2">3:2</option>
                  <option value="3:4">3:4</option>
                  <option value="4:3">4:3</option>
                  <option value="4:5">4:5</option>
                  <option value="5:4">5:4</option>
                  <option value="9:16">9:16</option>
                  <option value="16:9">16:9</option>
                  <option value="21:9">21:9</option>
                </select>
              </label>

              <label class="field">
                <span class="label">分辨率（可选）</span>
                <select id="imageSize">
                  <option value="">默认（1K）</option>
                  <option value="1K">1K</option>
                  <option value="2K">2K</option>
                  <option value="4K">4K</option>
                </select>
                <span class="hint">4K 成本更高、延迟更大。</span>
              </label>

              <label class="field">
                <span class="label">Temperature（可选，0–2）</span>
                <input id="temperature" type="number" inputmode="decimal" min="0" max="2" step="0.1" placeholder="留空使用模型默认" />
              </label>

              <label class="field">
                <span class="label">TopP（可选，0–1）</span>
                <input id="topP" type="number" inputmode="decimal" min="0" max="1" step="0.05" placeholder="留空使用模型默认" />
              </label>
            </div>
          </div>

          <div id="jsonModeWrap" class="hidden">
            <div class="jsonbar">
              <button id="jsonFormat" type="button" class="btn secondary">格式化 JSON</button>
              <button id="jsonFromForm" type="button" class="btn secondary">从表单同步</button>
              <button id="jsonToForm" type="button" class="btn secondary">回填到表单</button>
            </div>

            <label class="field full">
              <span class="label">请求体 JSON（将直接作为 POST body 发送）</span>
              <textarea id="requestBodyJson" rows="16" spellcheck="false"
                placeholder='例如：{"contents":[{"role":"user","parts":[{"text":""}]}],"generationConfig":{"responseModalities":["Image"]}}'></textarea>
              <span class="hint">提示：Host / Key 不在此 JSON 中；仍由上方固定配置决定。</span>
            </label>
          </div>
        </div>

        <!-- ============== 提示词反推面板 ============== -->
        <div id="paneDesc" class="hidden">
          <div class="modebar" role="tablist" aria-label="请求体编辑模式（提示词反推）">
            <button id="descModeForm" type="button" class="seg active" role="tab" aria-selected="true">表单模式</button>
            <button id="descModeJson" type="button" class="seg" role="tab" aria-selected="false">JSON 模式</button>
          </div>

          <div id="descFormModeWrap">
            <div class="grid">
              <label class="field">
                <span class="label">反推预设（通过覆盖系统提示词生效）</span>
                <select id="descPreset">
                  <option value="full">全图</option>
                  <option value="background">仅背景</option>
                  <option value="person">仅人物</option>
                  <option value="style">仅风格/画风</option>
                </select>
                <span class="hint">
                  该预设会把下方“系统提示词”替换为英文高精度反推指令；你可以在替换后继续手动微调。
                </span>
              </label>

              <label class="field">
                <span class="label">提示词（可选，作为补充要求）</span>
                <textarea id="descPrompt" rows="5" placeholder="可留空。可写：更偏电影感/更接近二次元/强调服装细节/保留logo等。"></textarea>
                <span class="hint">反推输出要求：仅输出英文提示词本体，不输出负面提示词、也不输出解释。</span>
              </label>

              <label class="field full">
                <span class="label">系统提示词（英文，反推模式核心）</span>
                <textarea id="descSystemPrompt" rows="10" spellcheck="false"></textarea>
                <span class="hint">会调用 gemini-3-pro-preview（非图像生成模型）。反推模式必须至少上传 1 张图片。</span>
              </label>

              <label class="field">
                <span class="label">Temperature（可选，0–2）</span>
                <input id="descTemperature" type="number" inputmode="decimal" min="0" max="2" step="0.1" placeholder="留空使用模型默认" />
              </label>

              <label class="field">
                <span class="label">Media resolution（可选）</span>
                <select id="descMediaResolution">
                  <option value="">默认</option>
                  <option value="MEDIA_RESOLUTION_LOW">LOW（64 tokens）</option>
                  <option value="MEDIA_RESOLUTION_MEDIUM">MEDIUM（256 tokens）</option>
                  <option value="MEDIA_RESOLUTION_HIGH">HIGH（zoomed reframing）</option>
                </select>
              </label>

              <label class="field">
                <span class="label">Thinking level（可选）</span>
                <select id="descThinkingLevel">
                  <option value="">默认（HIGH）</option>
                  <option value="MINIMAL">MINIMAL</option>
                  <option value="LOW">LOW</option>
                  <option value="MEDIUM">MEDIUM</option>
                  <option value="HIGH">HIGH</option>
                </select>
              </label>
            </div>
          </div>

          <div id="descJsonModeWrap" class="hidden">
            <div class="jsonbar">
              <button id="descJsonFormat" type="button" class="btn secondary">格式化 JSON</button>
              <button id="descJsonFromForm" type="button" class="btn secondary">从表单同步</button>
              <button id="descJsonToForm" type="button" class="btn secondary">回填到表单</button>
            </div>

            <label class="field full">
              <span class="label">反推请求体 JSON（将直接作为 POST body 发送）</span>
              <textarea id="descRequestBodyJson" rows="16" spellcheck="false"
                placeholder='例如：{"contents":[{"role":"user","parts":[{"text":""}]}],"generationConfig":{"temperature":0.7,"mediaResolution":"MEDIA_RESOLUTION_MEDIUM","thinkingConfig":{"thinkingLevel":"LOW"}}}'></textarea>
            </label>
          </div>
        </div>

        <div class="actions">
          <button id="runBtn" class="btn primary" type="submit">调用 API 生成</button>
          <button id="resetBtn" class="btn secondary" type="button">重置（不清 Host/Key）</button>
        </div>

        <div>
          <div id="status" class="status hidden"></div>
        </div>
      </form>
    </section>

    <section class="card">
      <h2 class="section-title">结果</h2>

      <div id="resultEmpty" class="empty">
        尚未生成。提交后会在这里显示图片与返回文本。
      </div>

      <div id="result" class="hidden">
        <div class="result-head">
          <div>
            <div class="kpi">
              <span class="kpi-label">模型</span>
              <span class="kpi-value" id="modelName"></span>
            </div>
            <div class="kpi">
              <span class="kpi-label">耗时</span>
              <span class="kpi-value" id="latency"></span>
            </div>
          </div>

          <div class="result-actions">
            <button id="copyCurl" type="button" class="btn secondary">复制 cURL</button>
            <button id="copyJson" type="button" class="btn secondary">复制请求 JSON</button>
          </div>
        </div>

        <div id="textOutWrap" class="block hidden">
          <h3 class="block-title">文本输出</h3>
          <pre id="textOut" class="pre"></pre>
        </div>

        <div id="imagesOutWrap" class="block hidden">
          <h3 class="block-title">图片输出</h3>
          <div id="imagesOut" class="gallery"></div>
          <p class="hint">
            iOS Safari 如遇“下载”不生效，请点击“打开原图”后长按图片保存到相册。
          </p>
        </div>

        <details class="details">
          <summary>查看原始响应 JSON</summary>
          <pre id="rawJson" class="pre"></pre>
        </details>
      </div>
    </section>

    <footer class="footer">
      <p class="footnote">
        说明：本页面仅做前端调用封装。建议对 API Key 做来源域名限制，或使用自建反代/Worker 将 Key 置于服务端。
      </p>
    </footer>
  </main>

  <script type="module" src="./app.js"></script>
</body>
</html>
